<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head th:replace="~{fragmentos/cabecero :: cabecero-seccion(titulo='Admin Folletos')}"></head>
<body>
<div th:replace="~{fragmentos/navegacion::navegacion-seccion}"></div>
<div class="container mt-4">
    <h3 th:text="${folleto.id==null} ? 'Agregar Folleto' : 'Editar Folleto'"></h3>

    <div th:if="${errorMessage!=null}" class="alert alert-danger" th:text="${errorMessage}"></div>
    <div th:if="${successMessage!=null}" class="alert alert-success" th:text="${successMessage}"></div>

    <!-- Si successMessage está presente (guardado reciente), ocultar el formulario y mostrar sólo el botón "Volver al listado" -->
    <div th:if="${successMessage!=null}">
        <div class="mb-3">
            <a class="btn btn-outline-info" th:if="${folleto.categoria==null or folleto.categoria=='FOLLETOS'}" th:href="@{/folletos}">Volver al listado</a>
            <a class="btn btn-outline-info" th:if="${folleto.categoria=='COMPAGINADOS'}" th:href="@{/folletos/combinados}">Volver al listado</a>
            <a class="btn btn-outline-info" th:if="${folleto.categoria=='LOCALES'}" th:href="@{/folletos/locales}">Volver al listado</a>
        </div>
    </div>
    <!-- Always show the form so user can continue editing after actions like deleting a file -->
    <form th:action="${folleto.id==null} ? @{/admin/folletos/add} : @{/admin/folletos/edit}" method="post" enctype="multipart/form-data" id="folletoForm" onsubmit="return validateForm()">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}" id="_csrf_token" data-csrf-param="${_csrf.parameterName}" />
        <input type="hidden" th:if="${folleto.id!=null}" name="id" th:value="${folleto.id}" />
        <div class="mb-3">
            <label class="form-label">Título</label>
            <input class="form-control" type="text" name="titulo" th:value="${folleto.titulo}" required />
        </div>
        <div class="mb-3">
            <label class="form-label">Categoría</label>
            <select class="form-select" name="categoria" id="categoriaSelect">
                <option th:value="'FOLLETOS'" th:selected="${folleto.categoria=='FOLLETOS'}">Folletos</option>
                <option th:value="'COMPAGINADOS'" th:selected="${folleto.categoria=='COMPAGINADOS'}">Folletos Compaginados</option>
                <option th:value="'LOCALES'" th:selected="${folleto.categoria=='LOCALES'}">Folletos Locales (solo PDF)</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">Año</label>
            <input class="form-control" type="number" name="ano" th:value="${folleto.ano}" min="1" max="3000" step="1" />
        </div>
        <div class="mb-3">
            <label class="form-label">Descripción</label>
            <textarea class="form-control" name="descripcion" rows="4" th:text="${folleto.descripcion}"></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label">Portada (imagen: jpg, png, webp)</label>
            <input class="form-control" type="file" name="coverFile" accept="image/*" />
            <div th:if="${folleto.coverFilename!=null}" style="margin-top:8px;">
                <p class="mb-1"><strong>Portada actual:</strong></p>
                <img th:src="@{/files/{id}/cover(id=${folleto.id})}" style="max-width:200px; display:block; margin-bottom:6px;" alt="Portada actual" />
            </div>
            <div th:if="${folleto.coverFilename==null}" class="form-text">No hay portada cargada.</div>
            <div class="form-text">Tamaño máximo por archivo: <span th:text="${T(java.lang.String).format('%.1f MB', (maxUploadBytes/1024.0/1024.0))}"></span></div>
        </div>
        <div class="mb-3">
            <label class="form-label">PDF</label>
            <!-- allow multiple PDFs -->
            <input class="form-control" type="file" name="pdfFiles" accept="application/pdf" id="pdfFilesInput" multiple />
            <div th:if="${folleto.pdfFilename!=null or (folleto.files != null)}" style="margin-top:8px;">
                <p class="mb-1"><strong>PDF(s) actual(es):</strong></p>
                <ul>
                    <!-- list related pdf FolletoFile entries -->
                    <li th:each="f : ${folleto.files}" th:if="${f.type == 'pdf'}">
                        <a th:href="@{/files/{id}/file/{fileId}(id=${folleto.id},fileId=${f.id})}" target="_blank" th:text="${f.originalName}">PDF</a>
                        <button type="button" class="btn btn-sm btn-outline-danger delete-file-btn" sec:authorize="hasRole('ROLE_ADMIN')" th:attr="data-action=@{/admin/folletos/{id}/files/delete/{fileId}(id=${folleto.id},fileId=${f.id})}" th:attrappend="data-confirm='Confirmar eliminación del archivo?'" style="margin-left:8px;">Eliminar</button>
                     </li>
                    <!-- legacy single-file link (kept for backward compat) -->
                    <li th:if="${folleto.pdfFilename!=null}">
                        <a th:href="@{/files/{id}/pdf(id=${folleto.id})}" target="_blank">Ver/Descargar PDF (legacy)</a>
                    </li>
                </ul>
            </div>
            <div th:if="${folleto.pdfFilename==null and (folleto.files == null or folleto.files.isEmpty())}" class="form-text">No hay PDF cargado.</div>
            <div class="form-text">Formatos permitidos: PDF</div>
        </div>
        <!-- Audio inputs hidden for LOCALES; render only when category is not LOCALES -->
        <div class="mb-3" th:if="${folleto.categoria == null or folleto.categoria != 'LOCALES'}">
            <label class="form-label">Audio (MP3, OGG, WAV, M4A, AAC)</label>
            <!-- allow multiple audio files -->
            <div id="audioFilesContainer">
                <div class="audio-input-row" style="display:flex; gap:8px; align-items:center;">
                    <input class="form-control" type="file" name="audioFiles" accept="audio/*" />
                    <button type="button" class="btn btn-sm btn-outline-primary add-audio-btn" title="Agregar otro audio">+</button>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-audio-btn" title="Quitar este audio">−</button>
                </div>
            </div>
            <div class="form-text">Puedes agregar varias partes presionando '+'. Cada input cargará un archivo separado.</div>
            <div th:if="${(folleto.files != null)}" style="margin-top:8px;">
                <p class="mb-1"><strong>Audio(s) actual(es):</strong></p>
                <div>
                    <!-- list related audio FolletoFile entries with players -->
                    <div th:each="f : ${folleto.files}" th:if="${f.type == 'audio'}" style="margin-bottom:10px;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <p class="mb-0" th:text="${f.originalName}"></p>
                            <button type="button" class="btn btn-sm btn-outline-danger delete-file-btn" sec:authorize="hasRole('ROLE_ADMIN')" th:attr="data-action=@{/admin/folletos/{id}/files/delete/{fileId}(id=${folleto.id},fileId=${f.id})}" th:attrappend="data-confirm='Confirmar eliminación del archivo de audio?'" style="display:inline;">Eliminar</button>
                        </div>
                        <audio controls style="max-width:320px; display:block; margin-bottom:6px;">
                            <source th:src="@{/files/{id}/file/{fileId}(id=${folleto.id},fileId=${f.id})}" />
                            Tu navegador no soporta el elemento de audio.
                        </audio>
                    </div>
                </div>
            </div>
            <div th:if="${folleto.audioFilename==null and (folleto.files == null or folleto.files.isEmpty())}" class="form-text">No hay audio cargado.</div>
            <div class="form-text">Formato recomendado: MP3. Si subes otro formato puede no reproducirse en todos los navegadores.</div>
        </div>
        <div class="mb-3">
            <p class="text-muted">Si no subes nuevos archivos, los archivos existentes se conservarán. Para eliminar un archivo existente usa la pantalla de detalle del folleto o la opción correspondiente en el panel de administración.</p>
        </div>
        <div class="mb-3">
            <button class="btn btn-primary" type="submit">Guardar</button>
            <a class="btn btn-secondary" th:if="${folleto.categoria==null or folleto.categoria=='FOLLETOS'}" th:href="@{/folletos}">Cancelar</a>
            <a class="btn btn-secondary" th:if="${folleto.categoria=='COMPAGINADOS'}" th:href="@{/folletos/combinados}">Cancelar</a>
            <a class="btn btn-secondary" th:if="${folleto.categoria=='LOCALES'}" th:href="@{/folletos/locales}">Cancelar</a>
        </div>
    </form>
</div>

<script th:inline="javascript">
// Client-side validation: check file sizes and basic types before submitting
function bytesToMB(bytes) { return bytes / 1024 / 1024; }
function validateForm() {
    const maxBytes = /*[[${maxUploadBytes}]]*/ 52428800;
    const yearInput = document.querySelector('input[name="ano"]');
    // inputs were changed to allow multiple file input elements
    const pdfInput = document.querySelector('#pdfFilesInput');
    const audioInputs = document.querySelectorAll('input[name="audioFiles"]');
    const coverInput = document.querySelector('input[name="coverFile"]');
    const categoria = document.querySelector('select[name="categoria"]');

    const allowedAudioExt = ['.mp3', '.ogg', '.wav', '.m4a', '.aac'];
    const allowedImageExt = ['.jpg', '.jpeg', '.png', '.webp'];

    function checkFileSingle(f, allowedExts, name) {
        // if no file provided, it's valid (nothing to check)
        if (!f) return true;
        if (f.size > maxBytes) {
            alert('El archivo ' + name + ' excede el tamaño máximo permitido de ' + (maxBytes / 1024 / 1024).toFixed(1) + ' MB.');
            return false;
        }
        const ext = f.name.substring(f.name.lastIndexOf('.')).toLowerCase();
        if (!allowedExts.includes(ext)) {
            alert('El archivo ' + name + ' tiene una extensión no permitida. Extensiones permitidas: ' + allowedExts.join(', '));
            return false;
        }
        return true;
    }

    function checkFiles(input, allowedExts, name) {
        if (!input) return true;
        // input may be either a single input element or a FileList
        if (input.files && input.files.length > 0) {
            for (let i = 0; i < input.files.length; i++) {
                if (!checkFileSingle(input.files[i], allowedExts, name)) return false;
            }
            return true;
        }
        return true;
    }

    if (yearInput.value && (yearInput.value < 1900 || yearInput.value > new Date().getFullYear() + 1)) {
        alert('El año debe estar entre 1900 y ' + (new Date().getFullYear() + 1) + '.');
        return false;
    }
    // check files only if the input section is visible and the input exists
    try {
        const pdfSectionVisible = pdfInput && pdfInput.closest && pdfInput.closest('.mb-3') && pdfInput.closest('.mb-3').offsetParent !== null;
        const audioSectionVisible = audioInputs && audioInputs.length>0 && audioInputs[0].closest && audioInputs[0].closest('.mb-3') && audioInputs[0].closest('.mb-3').offsetParent !== null;
        const coverSectionVisible = coverInput && coverInput.closest && coverInput.closest('.mb-3') && coverInput.closest('.mb-3').offsetParent !== null;

        if (pdfSectionVisible && !checkFiles(pdfInput, ['.pdf'], 'PDF')) {
            return false;
        }
        if (audioSectionVisible) {
            // validate all audio inputs
            for (let i=0;i<audioInputs.length;i++) {
                if (!checkFiles(audioInputs[i], allowedAudioExt, 'Audio')) return false;
            }
        }
        if (coverSectionVisible) {
            const coverFile = coverInput && coverInput.files && coverInput.files[0] ? coverInput.files[0] : null;
            if (!checkFileSingle(coverFile, allowedImageExt, 'Portada')) return false;
        }
    } catch (e) {
        // if any unexpected JS error occurs, don't block form submission; log to console
        console.error('Validation helper error:', e);
    }
    return true;
}
</script>

<!-- Hidden form used to submit delete requests (avoids nested forms) -->
<form id="deleteFileForm" method="post" style="display:none;">
    <input type="hidden" th:if="${_csrf!=null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
</form>

<script>
    // handle delete-file-btn clicks by submitting the hidden form with proper action and CSRF
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.delete-file-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                var action = btn.getAttribute('data-action');
                var confirmMsg = btn.getAttribute('data-confirm') || 'Confirmar eliminación?';
                if (!action) return;
                if (!confirm(confirmMsg)) return;
                var form = document.getElementById('deleteFileForm');
                form.action = action;
                form.submit();
            });
        });

        // Debug: intercept main form submit to log FormData (files included) before sending
        var mainForm = document.getElementById('folletoForm');
        if (mainForm) {
            mainForm.addEventListener('submit', function(e) {
                try {
                    var fd = new FormData(mainForm);
                    console.group('FolletoForm FormData');
                    for (var pair of fd.entries()) {
                        if (pair[1] instanceof File) {
                            console.log(pair[0], pair[1].name, pair[1].size + ' bytes');
                        } else {
                            console.log(pair[0], pair[1]);
                        }
                    }
                    console.groupEnd();
                } catch (ex) {
                    console.error('Error enumerating FormData:', ex);
                }
                // allow the form to submit normally
            });
        }
    });
</script>

<div th:replace="~{fragmentos/pie-pagina :: pie-pagina-seccion}"></div>
</body>
</html>